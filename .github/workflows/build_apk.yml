name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git zip unzip python3-pip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev cmake \
          libffi-dev libssl-dev build-essential wget
    
    - name: Install Python-for-Android
      run: |
        pip3 install python-for-android
        pip3 install Cython
    
    - name: Build APK with p4a
      working-directory: ./telegram_user_bot_kivy
      run: |
        p4a create --requirements=python3,kivy,telethon,certifi,pyopenssl \
          --arch=arm64-v8a \
          --bootstrap=sdl2 \
          --dist_name=telegramuserbot \
          --android_api=34 \
          --android_minapi=21
        p4a apk --private . \
          --package=org.telegram.telegramuserbot \
          --name "Telegram User Bot" \
          --version 0.1 \
          --bootstrap=sdl2 \
          --requirements=python3,kivy,telethon,certifi,pyopenssl \
          --arch=arm64-v8a \
          --android_api=34 \
          --main=main.py
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: telegram-user-bot-apk
        path: telegram_user_bot_kivy/bin/*.apk
        retention-days: 30
